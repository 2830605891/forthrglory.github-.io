<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <link rel="shortcut icon" href="http://some.url/to/favicon.ico">
    <title>小知识点-Forthrglory-不得贪胜</title>
    
        
            <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdn.bootcss.com/academicons/1.8.6/css/academicons.min.css" rel="stylesheet">
            <link href="https://cdn.bootcss.com/font-awesome/5.9.0/css/all.min.css" rel="stylesheet">
            <link href="https://cdn.bootcss.com/animate.css/3.7.2/animate.min.css" rel="stylesheet">
        
    
    
<link rel="stylesheet" href="/css/adagio.css">

<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="container-fluid">
    <nav class="nav">
        <div class="collapse navbar-collapse" id="navbar-sm">
            
            
            <div class="navbar-nav">
                <a href="http://forthrglory.com" target="_blank" rel="noopener" class="nav-item nav-link">forthrglory</a>
            </div>
            
        </div>
    </nav>
</div>

<div class="d-flex d-md-none" style="width: 100%; background-color: #e9ecef">
    
    <div class="nav">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-sm"
            aria-expanded="false" aria-label="Toggle Navigation">
            <i class="fas fa-bars fa-lg"></i>
        </button>
    </div>
    
    <nav class="navbar ml-auto">
        <a class="navbar-brand" href="/">
            
            Forthrglory
            
        </a>
    </nav>
</div>


<div class="container d-none d-md-block my-navbar">
    <nav class="navbar navbar-expand-sm navbar-light bg-transparent">
        <a class="navbar-brand " href="/">
            
            Forthrglory
            
        </a>
        
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                
                <li class="nav-item pl-2 pr-2 ">
                    <a class="nav-link" href="http://forthrglory.com" target="_blank" rel="noopener">forthrglory</a>
                </li>
                
            </ul>
        </div>
        
    </nav>
</div>




    <div class="jumbotron jumbotron-fluid">
    <div class="container">
        
        <h1 class="mt-4 article-title page-title">小知识点</h1>
        
        <p class="lead text-gray mt-3">By Anonymous; Published on 2018-12-23</p>
        
        <div class="tags">
            <ul class="tag-list">
                
                <li class="tag-list-item">
                    <a class="tag-list-link" href="/tags/%E7%9F%A5%E8%AF%86%E7%82%B9/">知识点</a>
                </li>
                
            </ul>
        </div>
        
    </div>
</div>
    <div class="container">
        <div class="row">
            <div class="col-md-9 pt-2">
                <div class="row">
                    <div class="col-12">
                        <main>
                            <article class="article-text page-content"><h3 id="记录学到的知识点"><a href="#记录学到的知识点" class="headerlink" title="记录学到的知识点"></a>记录学到的知识点</h3><p>HCTF没做出来2333，但是比赛完了看大佬们的解析还是学到了不少好东西</p>
<h5 id="关于unidecode编码问题"><a href="#关于unidecode编码问题" class="headerlink" title="关于unidecode编码问题"></a>关于unidecode编码问题</h5><p>介绍到一个函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def strlower(username):</span><br><span class="line">    username &#x3D; nodeprep.prepare(username)</span><br><span class="line">    return username</span><br></pre></td></tr></table></figure>
<p>这里将所有的输入进行转换成了小写，意味着’AAA’将会和’aaa’进行匹配，如果’aaa’之前进行了注册，那么你是无法注册’AAA’，但是这个函数带来了一个新的问题，就是’ᴀʙᴄᴅᴇꜰɢʜɪᴊᴋʟᴍɴᴏᴘʀꜱᴛᴜᴠᴡʏᴢ这些，这些字符在经过函数解析后会变成’ABCDEFGHIJKLMNOPQRSTUVWXYZ’，会注册成功，你会拿到’AAA’的账号，如果此时进行更改密码，再次对函数进行调用，’AAA’会被解析成’aaa’，即对’aaa’进行了越权更改</br><br><a href="https://tw.saowen.com/a/72b7816b29ef30533882a07a4e1040f696b01e7888d60255ab89d37cf2f18f3e" target="_blank" rel="noopener">详细介绍</a></p>
<h2 id="白帽子里的注入"><a href="#白帽子里的注入" class="headerlink" title="白帽子里的注入"></a>白帽子里的注入</h2><h4 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h4><p>SQL注入还是挺常见的，最简单的不过是什么过滤都没有，直接注入，接着就是盲注了，写个脚本自己去跑可以，或者用SQL-MAP也行。接着就是基于时间的SQL注入，通过一些内置的时间函数进行注入，典型例子例如MYSQL的BENCHMARK函数，这个函数是用来测试函数性能的函数，例如BENCHMARK(1000000, md5(1))是将md5这个函数对1进行加密1000000次，基于这个函数，可以返回比一般响应要长的多时间，从而判断是否注入正确</p>
<h4 id="数据库注入技巧"><a href="#数据库注入技巧" class="headerlink" title="数据库注入技巧"></a>数据库注入技巧</h4><p>除了对数据进行注入，也可以对数据库进行注入，例如将内容导出来或者将某个shell文件导入数据库中。除此之外，还有命令注入，即利用”用户自定义函数“的技巧，进行UDF执行命令。还有攻击储存过程和编码问题，也就是常说的宽字节注入<br>。接下来就是注入的长度问题，在SQL的配置中，有一个sql-mode选项，如果该选项设置为default，那么sql对于用户插入的超长数据只会报告一个warning错误，而不会中断，这可能会导致一些截断问题，此时如果插入两个相同的数据，则会造成一些不可预知的错误，例如说数据库里本身有一个username=admin&amp;password=xxx的数据，如果此时注入一个admin                             x，只要空格长度超过了读取的最大长度即可，此时系统判断和admin并非一个用户，注册成功，但在插入数据库的时候，数据库不支持这么长的长度，因此他只插入了admin即后面空格，x被截断，而admin              和admin等价，因此可以利用注册admin                          x时的密码对admin密码进行更改，从而造成了越权访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">针对SQL注入，要始终坚持数据和代码分离原则，数据就是数据，代码就是代码，尽可能的不要讲用户的数据直接放到代码中执行，同时如果非要执行，那么一定要加上过滤，最好是白名单过滤， 因为黑名单过滤已经不止一次地用鲜血案例警告我们，同时也可以使用预编译语句进行防御</span><br></pre></td></tr></table></figure>
<h4 id="其他注入"><a href="#其他注入" class="headerlink" title="其他注入"></a>其他注入</h4><p>其他注入包括一些XML注入和CSRF注入等，XSS就可以认为是XML注入的一种，具体请自行百度或参考《白帽子讲web安全》</p>
<h3 id="模板注入"><a href="#模板注入" class="headerlink" title="模板注入"></a>模板注入</h3><p>做了好几个比赛了，也看到了不少注入题目，说实话，一般的SQL注入已经很少见了，所以这里记录下模板注入的一些知识<br>首先简述下模板的一些知识</br><br>模板是一种在两种语言相互插入时使用的可以成为API的一种，譬如说一段php中插入一大段的html代码，不仅写起来十分的复杂麻烦，修改的时候更是让人无从下手，而模板则简化了这种设计，例如说，在一串php代码中引用了html的标签，正常书写时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">return &quot;&lt;html&gt;xxx</span><br><span class="line">xxx</span><br><span class="line">xxx</span><br><span class="line">xxx</span><br><span class="line">&lt;&#x2F;html&gt;&quot;</span><br></pre></td></tr></table></figure>
<p>而如果使用了模板就简单多了，直接return你所设定的值即可</br><br>例如说html中插入php，完全可以直接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a action&#x3D;&#123;&#123;action&#125;&#125; &#x2F;&gt;</span><br></pre></td></tr></table></figure>
<p>然后你在php的代码里有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assign(&#39;action&#39;, &#39;login.php&#39;);</span><br></pre></td></tr></table></figure>
<p>便不必再写那冗长复杂的代码了</p>
<h4 id="Flask模板注入"><a href="#Flask模板注入" class="headerlink" title="Flask模板注入"></a>Flask模板注入</h4><p>一般代码都会对用户的输入进行过滤，但是涉及到模板这个地方，过滤一般很少或者没有，大都是遗漏这个地方。</br><br>因此如果代码中有一处输入时用户可控的，这就意味这用户可以执行模板表达式，这就造成了注入（XSS是可以进行模板注入的先决条件之一）</br><br>可以利用{{7+7}}进行测试是否有模板注入点，如果返回值为14，则一般存在模板注入点，通过{{config}}可以读取系统配置，具体细节贴出来大佬们的介绍</p>
<blockquote>
<p>注入姿势：</br><br>　　1）、内省request对象。request对象是一个Flask模板全局变量，代表“当前请求对象（flask.request）”。当你在视图中访问request对象时，它包含了你预期想看到的所有信息。在request对象中有一个叫做environ的对象。request.environ是一个字典，其中包含和服务器环境相关的对象。该字典当中有一个shutdown_server的方法，相应的key值为werkzeug.server.shutdown。所以猜猜看我们向服务端注入{{ request.environ['werkzeug.server.shutdown']() }}会发生什么？没错，会产生一个及其低级别的拒绝服务。当使用gunicorn运行应用程序时就不会存在这个方法，所以漏洞就有可能受到开发环境的限制。</br><br>　　2）、内省config对象。config对象是一个Flask模板全局变量，代表“当前配置对象（flask.config）”。它是一个类似于字典的对象，其中包含了应用程序所有的配置值，包含若干独特方法的子类：from_envvar，from_object，from_pyfile，以及root_path。在大多数情况下，会包含数据库连接字符串，第三方服务凭据，SECRET_KEY之类的敏感信息。对于新加载的模块，from_object方法会将那些变量名全是大写的属性添加到config对象中。注入payload{{ config.items() }}就可以轻松查看这些配置了。</br><br>　　3）、使用非常重要的内省组件： <strong>mro</strong>和<strong>subclasses</strong>属性。</br><br>　　　　<strong>mro</strong>中的MRO代表方法解析顺序，并且在这里定义为，“是一个包含类的元组，而其中的类就是在方法解析的过程中在寻找父类时需要考虑的类”。<strong>mro</strong>属性以包含类的元组来显示对象的继承关系，它的父类，父类的父类，一直向上到object（如果是使用新式类的话）。它是每个对象的元类属性，但它却是一个隐藏属性，因为Python在进行内省时明确地将它从dir的输出中移除了（见Objects/object.c的第1812行）。subclasses__属性则在这里被定义为一个方法，“每个新式类保留对其直接子类的一个弱引用列表。此方法返回那些引用还存在的子类”。</br><br>　　**　　使用<strong>mro</strong>属性来访问对象的父类，使用<strong>subclasses</strong>属性来访问对象的子类。</br><br>　　4）、{{ ''.__class__.__mro__ }}作为payload注入到SSTI漏洞点当中，使用索引2来选择object类。现在我们到达了object类，我们使用<strong>subclasses</strong>属性来dump应用程序中使用的所有类（找到file类的索引）将{{ ''.__class__.__mro__[2].__subclasses__() }}注入到SSTI漏洞点当中</br><br>　　5）、任意文件读取POC:</br><br>　　　　　file类能够实例化文件对象，而且如果我们实例化了一个文件对象，那么我们就可用使用类似于read的方法来读取相关内容。找到file类的索引，在我的环境中&lt;type ‘file’&gt;类的索引是40，我们就注入{{ ''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read() }}。所以现在我们就证明了，通过Flask/Jinja2中的SSTI进行任意文件读取是有可能的。</br></p>
</blockquote>
<p>详情请参考<a href="https://www.cnblogs.com/tyomcat/p/5440488.html" target="_blank" rel="noopener">SSTI攻击</a></br><br><a href="https://www.freebuf.com/articles/web/98619.html" target="_blank" rel="noopener">探究flask/jinja2中的模板攻击</a></p>
<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><p>简单的文件上传就不再赘述，首先要说的是PUT上传，这种上传方式允许用户将文件上传到指定文件夹，于此便可以先上传一个txt文件绕过，然后通过MOVE进行改名。其次是Nginx的问题，例如说上传一个test.jpg，然后访问htt[://127.0.0.1/test.jpg/123.php，其中123.php是不存在的文件，那么它会将test.jpg当作php文件执行。接下来还有通过文件上传进行钓鱼的方式</br><br>针对文件上传的安全问题，可以通过一下几点</p>
<ol>
<li>将文件目录设置为不可执行，即无法对上传文件进行运行，即使上传了webshell也无法执行，保证了安全</li>
<li>判断文件类型，如果是有害的文件类型例如php,asp则拒绝上传，不过这里还是推荐进行白名单验证而非黑名单，因为随着更新总会有一些新文件名出现而你无法及时更新黑名单的情况</li>
<li>使用随机数改写文件名和文件路径，这将对上传之后的访问造成极大的困扰</li>
<li>单独设置文件服务器的域名，由于浏览器的同源策略，会导致一些攻击失效，但具体还要看环境</li>
</ol>
</article>
                        </main>
                        
                        
                    </div>
                </div>
                <div class="row mt-5 mb-5">
                    <div class="col-12">
                        <div class="row">
    <div class="col">
        <nav aria-label="paginator" class="paginator">
            <ul class="pagination d-none d-md-flex pagination-lg justify-content-center">
                <li class="page-item ">
                    <a class="page-link"
                        href="/2018/12/23/%E5%BD%AD%E5%9F%8E%E6%9D%AF/"
                        aria-label="Previous">
                        <span aria-hidden="true">&laquo;
                            彭城杯2018WP</span>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
                <li class="page-item ">
                    <a class="page-link"
                        href="/2018/12/23/%E7%A7%91%E6%9D%A5%E6%9D%AF/"
                        aria-label="Next">
                        <span
                            aria-hidden="true">山东省大学生网络安全竞赛2018
                            &raquo;</span>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
            </ul>
            <ul class="pagination d-md-none justify-content-center">
                <li class="page-item ">
                    <a class="page-link"
                        href="/2018/12/23/%E5%BD%AD%E5%9F%8E%E6%9D%AF/"
                        aria-label="Previous">
                        <span aria-hidden="true">&laquo;
                            彭城杯2018WP</span>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
                <li class="page-item ">
                    <a class="page-link"
                        href="/2018/12/23/%E7%A7%91%E6%9D%A5%E6%9D%AF/"
                        aria-label="Next">
                        <span
                            aria-hidden="true">山东省大学生网络安全竞赛2018
                            &raquo;</span>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>



                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div id="vcomment"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="container pt-4 page-sidebar">
                    
                    <div class="row">
    <div class="col">
        <h6>APPLAUSE FOR ME</h6>
        <div id="applause-easy"></div>
    </div>
</div>
                    
                    <hr class="row">
                    <div class="row toc-container">
                        <div class="col-12">
                            <h6>NAVIGATION</h6>
                            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#记录学到的知识点"><span class="toc-text">记录学到的知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#关于unidecode编码问题"><span class="toc-text">关于unidecode编码问题</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#白帽子里的注入"><span class="toc-text">白帽子里的注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL注入"><span class="toc-text">SQL注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据库注入技巧"><span class="toc-text">数据库注入技巧</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他注入"><span class="toc-text">其他注入</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模板注入"><span class="toc-text">模板注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Flask模板注入"><span class="toc-text">Flask模板注入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件上传"><span class="toc-text">文件上传</span></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer>
    <div class="jumbotron jumbotron-fluid mb-0">
        <div class="container-fluid">
            <div class="col text-center">
                <div class="bottom-social">
                    <div class="row">
    <div class="col text-center">
        <ul class="list-inline">
            
            <li class="list-inline-item">
                
                <a href="https://github.com/forthrglory" target="_blank" rel="noopener">
                    <span class="fa-stack fa-2x icon-link">
                        <i class="fas fa-circle fa-stack-2x"></i>
                        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                    </span>
                </a>
                
            </li>
            
            <li class="list-inline-item">
                
                <a href="https://www.facebook.com/xxxxx" target="_blank" rel="noopener">
                    <span class="fa-stack fa-2x icon-link">
                        <i class="fas fa-circle fa-stack-2x"></i>
                        <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
                    </span>
                </a>
                
            </li>
            
            <li class="list-inline-item">
                
                <a href="https://www.pinterest.com/xxxxx" target="_blank" rel="noopener">
                    <span class="fa-stack fa-2x icon-link">
                        <i class="fas fa-circle fa-stack-2x"></i>
                        <i class="fab fa-pinterest-p fa-stack-1x fa-inverse"></i>
                    </span>
                </a>
                
            </li>
            
            <li class="list-inline-item">
                
                <a href="https://www.linkedin.com/in/xxxxx" target="_blank" rel="noopener">
                    <span class="fa-stack fa-2x icon-link">
                        <i class="fas fa-circle fa-stack-2x"></i>
                        <i class="fab fa-linkedin-in fa-stack-1x fa-inverse"></i>
                    </span>
                </a>
                
            </li>
            
        </ul>
    </div>
</div>

                </div>
                <p class="copyright text-muted">
                    Copyright &copy; Hexo
                    <br>
                    Thanks for coming!
                    <br>
                    <a href="https://github.com/Hanlin-Dong/hexo-theme-adagio" target="_blank" rel="noopener">Adagio</a> - A <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> theme made with love by
                    <a href="http://www.hanlindong.com" target="_blank" rel="noopener">Hanlin Dong</a>.
                </p>
            </div>
        </div>
    </div>
</footer>

    
    
        <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.slim.min.js"></script>
        <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.bootcss.com/font-awesome/5.9.0/js/all.min.js"></script>
         
            <script type="text/x-mathjax-config">
                MathJax.Hub.Config({
                    CommonHTML: { linebreaks: { automatic: true } },
                    "HTML-CSS": { linebreaks: { automatic: true } },
                    SVG: { linebreaks: { automatic: true } }
                });
            </script>
            <script src='https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>
        
    



<script src="/js/av.min.js"></script>


<script src="/js/valine.min.js"></script>


<script src="/js/applause-easy.js"></script>

<script src="http://forthrglory.com/live2d-widget/autoload.js"></script>

<script>
$(document).ready(function() {
    var a = new ApplauseEasy({
        id: 'applause-easy',
        appId: "xxxxxxxxxx",
        appKey: "xxxxxxxxxx",
        img_src: "http://img.hanlindong.com/blog/site/clap.png",
        img_width: "50px",
        img_height: "50px"
    })
})
</script>


<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?123456789";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-11111111-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-11111111-1');
</script>


    
    <script>
    new Valine({
        el: "#vcomment",
        appId: "xxxxxxxxxx",
        appKey: "xxxxxxxxxx",
        notify: false,
        varify: false,
        avatar: 'identicon',
        placeholder: "",
        recordIP: true
    })
</script>
    
</body>
</html>